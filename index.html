






<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Ideas 4 Math Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root {
      --tiffany-blue: #e3f8fa;
      --matrix-header: #8ed7e6;
      --tab-active: #1790f7;
      --tab-inactive: #b6e4ed;
      --tab-hover: #8ed7e6;
      --border: #c7e6ec;
      --header: #1790f7;
    }
    body {
      background: var(--tiffany-blue);
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #192a3e;
      min-height: 100vh;
    }
    .company-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 25px;
      margin-bottom: 3px;
      margin-top: 10px;
    }
    .company-name {
      font-size: 1.02rem;
      color: var(--header);
      font-weight: 700;
      letter-spacing: 1.2px;
      opacity: 0.85;
    }
    .portal-title {
      text-align: center;
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--header);
      margin: 32px 0 24px 0;
      letter-spacing: 2px;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 3px;
      margin: 0 auto 0 auto;
      position: static;
      z-index: 9;
      max-width: 900px;
    }
    .tab-btn {
      flex: 1 1 150px; 
      min-width: 120px;
    }
    .tab-btn {
      background: var(--tab-inactive);
      color: #222;
      font-size: 1.03rem;
      font-weight: 600;
      border: none;
      border-radius: 9px 9px 0 0;
      padding: 11px 19px 9px 19px;
      cursor: pointer;
      outline: none;
      box-shadow: 0 2px 6px #0001;
      transition: background 0.18s;
    }
    .tab-btn.active {
      background: var(--tab-active);
      color: #fff;
    }
    .tab-btn:hover:not(.active) {
      background: var(--tab-hover);
    }
    .main-content {
      background: #ffffffee;
      border-radius: 18px;
      box-shadow: 0 6px 30px 0 #0001;
      margin: 28px auto 42px auto;
      padding: 28px;
      max-width: 1170px;
      min-width: 320px;
      min-height: 520px;
      position: relative;
    }
    @media (max-width: 900px) {
      .main-content, .matrix-container { padding: 8px; }
      .tabs { right: 0; top: 0; }
      .portal-title { font-size: 1.3rem; }
      .company-bar { padding-left: 5px; }
      .company-name { font-size: 0.93rem; }
    }
    .section {
      background: #fafdff;
      border-radius: 13px;
      padding: 18px 22px 18px 22px;
      margin-bottom: 18px;
      border: 1.5px solid #e6f0f7;
      margin-top: 18px;
    }
    .section-title {
      font-size: 1.18rem;
      font-weight: 700;
      color: #111;
      margin-bottom: 11px;
      margin-top: 0;
    }
    label, .legend {
      font-size: 1.08rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .attendance-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: #e9f5ff;
      border-radius: 9px 9px 0 0;
      overflow: hidden;
      box-shadow: 0 2px 6px #0001;
    }
    .attendance-table th, .attendance-table td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1.5px solid #d5ecfb;
    }
    .attendance-table th {
      background: #d5ecfb;
      font-weight: 700;
      color: #1790f7;
      font-size: 1.01rem;
    }
    .attendance-table tr:last-child td {
      border-bottom: none;
    }
    .attendance-table td:first-child {
      text-align: left;
      font-weight: 600;
      color: #1c69a8;
    }
    .status-checkbox {
      accent-color: #1790f7;
      transform: scale(1.1);
      cursor: pointer;
    }
    .legend {
      font-size: 1rem;
      font-weight: 400;
      color: #444;
      margin-bottom: 7px;
      margin-top: 3px;
    }
    .remark-box {
      width: 100%;
      resize: vertical;
      min-height: 38px;
      font-size: 1rem;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1.2px solid #c2e0f8;
      background: #fafdff;
      box-sizing: border-box;
      margin-top: 8px;
    }
    .submit-row {
      text-align: center;
      margin-top: 24px;
    }
    .submit-btn {
      background: #1790f7;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 10px 28px;
      font-size: 1.13rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #1790f722;
      transition: background 0.18s;
    }
    .submit-btn:hover {
      background: #1273c6;
    }
    .message {
      text-align: center;
      margin-top: 12px;
      color: #1790f7;
      font-weight: 600;
      min-height: 24px;
    }
    .attendance-analysis {
      font-size: 1.08rem;
      margin: 20px 0 10px 0;
      color: #2b7a96;
      font-weight: 600;
      background: #e9f5ff;
      padding: 7px 16px;
      border-radius: 7px;
      display: inline-block;
    }
    .day-of-week {
      font-size: 1.08rem;
      font-weight: 500;
      color: #1790f7;
      margin-left: 8px;
    }
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      background: #e9f5ff;
      border-radius: 9px 9px 0 0;
      overflow: auto;
      box-shadow: 0 2px 6px #0001;
      margin-top: 18px;
      font-size: 0.98rem;
    }
    .matrix-table th, .matrix-table td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1.5px solid #d5ecfb;
      border-right: 1.5px solid #d5ecfb;
      max-width: 60px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .matrix-table th:last-child, .matrix-table td:last-child {
      border-right: none;
    }
    .matrix-table th {
      background: var(--matrix-header);
      font-weight: 700;
      color: #0a5077;
      font-size: 1.01rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .matrix-table td:first-child, .matrix-table th:first-child {
      position: sticky;
      left: 0;
      background: var(--matrix-header);
      color: #1c69a8;
      z-index: 1;
      text-align: left;
      font-weight: 600;
      min-width: 160px;
      max-width: 180px;
      white-space: normal;
    }
    .matrix-table td.remarks-cell {
      max-width: 180px;
      white-space: normal;
      text-align: left;
      font-size: 0.95rem;
      color: #333;
      background: #fafbfc;
    }
    .matrix-legend {
      font-size: 1rem;
      font-weight: 400;
      color: #444;
      margin: 12px 0 6px 0;
      text-align: center;
    }
    .filter-row {
      margin: 8px 0 12px 0;
      text-align: right;
    }
    .filter-input {
      font-size: 1rem;
      padding: 5px 7px;
      border-radius: 6px;
      border: 1px solid #b6e4ed;
      margin-right: 10px;
      min-width: 140px;
      background:#fafdff;
    }
    .matrix-table .matrix-percent {
      color: #167c3b;
      font-weight: 700;
    }
    .matrix-table input[type="number"] {
      width: 55px;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid #b6e4ed;
      background: #fafbfc;
      font-size: 0.98rem;
      text-align: center;
    }
    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
      animation: fadein 0.32s;
    }
    @keyframes fadein {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .form-table, .payment-table, .exam-table, .homework-table, .feedback-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }
    .form-table th, .form-table td,
    .payment-table th, .payment-table td,
    .exam-table th, .exam-table td,
    .homework-table th, .homework-table td,
    .feedback-table th, .feedback-table td {
      border: 1px solid #b6e4ed;
      padding: 7px 5px;
      text-align: left;
      font-size: 1rem;
      background: #fafdff;
    }
    .form-table th, .payment-table th, .exam-table th, .homework-table th, .feedback-table th {
      background: #e9f5ff;
      color: #1790f7;
      font-weight: 700;
    }
    .input-small {
      width: 90px;
    }
    .input-medium {
      width: 140px;
    }
    .input-large {
      width: 220px;
    }
    .notice-board {
      background: #e9f5ff;
      border-radius: 10px;
      padding: 12px 20px;
      margin: 16px 0 0 0;
      font-size: 1.07rem;
      color: #1c69a8;
    }
    .notice-title {
      font-size: 1.13rem;
      font-weight: bold;
      color: #1790f7;
      margin-bottom: 7px;
    }
    .notice-date {
      color: #e40000 !important;
      text-decoration: underline wavy #e40000;
      font-weight: 700;
    }
    .file-upload {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .file-list {
      margin: 0;
      padding: 0 0 0 18px;
      font-size: 0.98rem;
    }
    .comment-box, .feedback-box {
      width: 100%;
      min-height: 40px;
      border-radius: 6px;
      border: 1.2px solid #c2e0f8;
      padding: 7px 12px;
      font-size: 1rem;
      background: #fafdff;
      margin-bottom: 8px;
      resize: vertical;
      box-sizing: border-box;
    }
    .btn, .matrix-table .edit-btn, .matrix-table .save-btn, .matrix-table .cancel-btn {
      background: #1790f7;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 22px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #1790f722;
      transition: background 0.18s;
      margin-top: 7px;
      margin-right: 7px;
      margin-bottom: 7px;
    }
    .btn:hover, .edit-btn:hover, .save-btn:hover, .cancel-btn:hover {
      background: #1273c6;
    }
    .edit-btn, .save-btn, .cancel-btn {
      padding: 4px 9px !important;
      font-size: 0.9rem !important;
      margin: 0 2px !important;
    }
    .percent-bar-bg {
      background: #e6f0f7;
      border-radius: 8px;
      height: 16px;
      width: 98px;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
      position: relative;
    }
    .percent-bar-fill {
      background: #1790f7;
      border-radius: 8px;
      height: 16px;
      min-width: 8px;
      position: absolute;
      left: 0; top: 0;
    }
    .percent-label {
      font-size: 0.99rem;
      font-weight: 600;
      color: #2b7a96;
      vertical-align: middle;
      margin-left: 4px;
    }
    .notice-conclusion, .comment-conclusion {
      margin-top: 1em;
      border-top: 1px solid #ccc;
      font-weight: 600;
      color: #1790f7;
      padding-top: 0.7em;
    }
    .hide {
      display: none !important;
    }
    #notice-popup-modal {
      display:none;
      position:fixed;
      z-index:9999;
      top:0;
      left:0;
      width:100vw;
      height:100vh;
      background:rgba(0,0,0,0.28);
      align-items:center;
      justify-content:center;
    }
    #notice-popup-content {
      background:#fff;
      padding:28px 36px 16px 36px;
      border-radius:14px;
      box-shadow:0 8px 40px #0004;
      min-width:260px;
      max-width:90vw;
      max-height:90vh;
      overflow:auto;
      position:relative;
    }
    .notice-popup-date {
      color: #e40000 !important;
      text-decoration: underline wavy #e40000;
      font-weight: 700;
    }
/* 1. Matrix date columns same width */
.matrix-table th.matrix-date,
.matrix-table td.matrix-date {
  min-width: 88px;
  max-width: 88px;
  width: 88px;
  /* Prevent shrink/grow */
  white-space: nowrap;
}
/* 2. Attendance status coloring in matrix */
.matrix-status-P { color: #1790f7 !important; font-weight: 700; }
.matrix-status-A { color: #888 !important; font-weight: 700; }
.matrix-status-X { color: #e40000 !important; font-weight: 700; }
.matrix-status-R { color: #1dbb75 !important; font-weight: 700; }
.matrix-status-PH { color: #e9b200 !important; font-weight: 700; }
  </style>
</head>
<body>
  <div class="company-bar">
    <span class="company-name">Smart Ideas 4 Math</span>
  </div>
  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="attendance">Attendance</button>
    <button class="tab-btn" data-tab="matrix">Attendance Matrix</button>
    <button class="tab-btn" data-tab="exam">Exam Scores</button>
    <button class="tab-btn" data-tab="payment">Payment</button>
    <button class="tab-btn" data-tab="notice">Notice Board</button>
    <button class="tab-btn" data-tab="uploadhw">Upload Homework</button>
    <button class="tab-btn" data-tab="submithw">Submit Homework</button>
    <button class="tab-btn" data-tab="comment">Teacher Comments</button>
    <button class="tab-btn" data-tab="feedback">Parent Feedback</button>
  </div>
  <div class="main-content">
    <!-- Attendance Tab -->
    <div class="tab-section active" id="tab-attendance">
      <div class="portal-title">Student Attendance</div>
      <form id="attendance-form" autocomplete="off">
        <div class="section">
          <div class="section-title">1. Select Date</div>
          <input type="date" id="date" name="date" required>
          <span id="day-of-week" class="day-of-week"></span>
        </div>
        <div class="section">
          <div class="section-title">2. Mark Attendance</div>
          <div class="legend">
            P = Present, A = Absent, X = Missed/Need Replace, R = Replacement, PH = Public Holiday
          </div>
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>P</th>
                <th>A</th>
                <th>X</th>
                <th>R</th>
                <th>PH</th>
              </tr>
            </thead>
            <tbody id="student-tbody"></tbody>
          </table>
        </div>
        <div class="section">
          <div class="section-title">Note / Remark (Optional)</div>
          <textarea id="remark" name="remark" class="remark-box" placeholder="E.g., Eva left early; Alden will replace tomorrow..."></textarea>
        </div>
        <div class="submit-row">
          <button type="submit" class="submit-btn">Save Attendance</button>
        </div>
        <div class="message" id="message"></div>
      </form>
      <div id="attendance-analysis"></div>
    </div>
    <!-- Attendance Matrix Tab (EDITABLE) -->
    <div class="tab-section" id="tab-matrix">
      <div class="portal-title">Attendance Matrix</div>
      <div class="filter-row">
        <input type="text" id="matrix-filter" class="filter-input" placeholder="Filter student/class/month...">
      </div>
      <div class="matrix-legend">
        P = Present, A = Absent, X = Missed/Need Replace, R = Replacement, PH = Public Holiday
      </div>
      <div id="matrix-table-wrapper" style="overflow:auto;">
        <form id="matrix-form">
          <table class="matrix-table" id="matrix-table"></table>
        </form>
      </div>
      <div style="text-align:right;margin-top:12px;">
        <button class="btn" onclick="exportMatrix()">Export CSV</button>
        <button class="btn" id="matrix-save-btn" type="button">Save Changes</button>
      </div>
      <div id="matrix-message" class="message"></div>
    </div>
    <!-- Exam Scores Tab -->
    <div class="tab-section" id="tab-exam">
      <div class="portal-title">Student Exam Scores</div>
      <div class="filter-row">
        <input type="text" id="exam-filter" class="filter-input" placeholder="Filter by name/class/exam...">
      </div>
      <form id="exam-form">
        <table class="exam-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Class</th>
              <th>Exam Name</th>
              <th>Score (%)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="exam-tbody"></tbody>
          <tfoot>
            <tr>
              <td>
                <select id="exam-student" class="input-medium"></select>
              </td>
              <td>
                <span id="exam-class" style="font-weight:600;color:#1790f7;"></span>
              </td>
              <td>
                <select id="exam-name" class="input-medium">
                  <option>Exam 1</option>
                  <option>Exam 2</option>
                  <option>Exam 3</option>
                  <option>Exam 4</option>
                  <option>UEC Exam</option>
                  <option>SPM Exam</option>
                  <option value="other">Others (type below)</option>
                </select>
                <input type="text" id="exam-other" class="input-medium" placeholder="Other Exam Name" style="display:none;margin-top:4px;">
              </td>
              <td>
                <input type="number" id="exam-score" class="input-small" min="0" max="100" step="0.01" placeholder="Score">
              </td>
              <td>
                <button type="submit" class="btn">Add</button>
              </td>
            </tr>
          </tfoot>
        </table>
      </form>
    </div>
    <!-- Payment Tab -->
    <div class="tab-section" id="tab-payment">
      <div class="portal-title">Payment Records</div>
      <div class="filter-row">
        <input type="text" id="payment-filter" class="filter-input" placeholder="Filter by name/class/month...">
      </div>
      <form id="payment-form">
        <table class="payment-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Class</th>
              <th>Amount (RM)</th>
              <th>Month</th>
              <th>Pay On</th>
              <th>Paid By</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="payment-tbody"></tbody>
          <tfoot>
            <tr>
              <td>
                <select id="payment-student" class="input-medium"></select>
              </td>
              <td>
                <span id="payment-class" style="font-weight:600;color:#1790f7;"></span>
              </td>
              <td id="payment-auto-amount"></td>
              <td>
                <input type="month" id="payment-month" class="input-small">
              </td>
              <td>
                <input type="date" id="payment-date" class="input-small">
              </td>
              <td>
                <select id="payment-paidBy" class="input-small">
                  <option value="PBB">PBB</option>
                  <option value="CIMB">CIMB</option>
                  <option value="MBB">MBB</option>
                  <option value="Cash">Cash</option>
                </select>
              </td>
              <td>
                <select id="payment-status" class="input-small">
                  <option value="Paid">Paid</option>
                  <option value="Unpaid">Unpaid</option>
                </select>
              </td>
              <td>
                <button type="submit" class="btn">Add</button>
              </td>
            </tr>
          </tfoot>
        </table>
      </form>
      <div class="section" style="max-width:330px;">
        <div class="section-title" style="font-size:1.08rem;">Set Payment Amounts</div>
        <select id="setpay-student" class="input-medium"></select>
        <input type="number" id="setpay-amount" class="input-small" min="0" placeholder="Amount RM">
        <button type="button" class="btn" style="padding:5px 13px;font-size:0.98rem;" onclick="setPaymentAmount()">Set</button>
        <span id="setpay-msg" style="margin-left:7px;color:#1790f7;font-size:0.97rem;"></span>
      </div>
    </div>
    <!-- Notice Board Tab -->
    <div class="tab-section" id="tab-notice">
      <div class="portal-title">Notice Board</div>
      <form id="notice-form">
        <div class="notice-title">Post New Notice / Info</div>
        <input type="text" id="notice-title" class="input-large" placeholder="Notice Title" required>
        <label style="margin-left:18px;">Period:
          <input type="date" id="notice-period-start" required> to
          <input type="date" id="notice-period-end" required>
        </label>
        <br>
        <textarea id="notice-content" class="remark-box" placeholder="Type notice, schedule, or holiday info here..." required></textarea>
        <br>
        <button type="submit" class="btn">Post Notice</button>
      </form>
      <div id="notice-list" class="notice-board"></div>
    </div>
    <!-- Upload Homework Tab -->
    <div class="tab-section" id="tab-uploadhw">
      <div class="portal-title">Upload Homework (Teacher)</div>
      <form id="uploadhw-form">
        <input type="text" id="uploadhw-title" class="input-large" placeholder="Homework Title" required>
        <input type="text" id="uploadhw-desc" class="input-large" placeholder="Description (optional)">
        <label style="display:block;margin:7px 0 4px 0;">Class:
          <select id="uploadhw-class" class="input-medium"></select>
        </label>
        <label style="display:block;margin:7px 0 4px 0;">Due Date:
          <input type="date" id="uploadhw-due" class="input-small" required>
          <input type="time" id="uploadhw-duetime" class="input-small" required>
        </label>
        <div class="file-upload">
          <label>Attach file: <input type="file" id="uploadhw-file"></label>
        </div>
        <button type="submit" class="btn">Upload</button>
      </form>
      <div id="hw-list" style="margin-top:18px;"></div>
    </div>
    <!-- Submit Homework Tab -->
    <div class="tab-section" id="tab-submithw">
      <div class="portal-title">Submit Homework (Student)</div>
      <form id="submithw-form">
        <label>Student:
          <select id="submithw-student" class="input-medium"></select>
        </label>
        <label style="margin-left:20px;">Homework:
          <select id="submithw-hw" class="input-large"></select>
        </label>
        <div>
          <label>Description:<br>
            <textarea id="submithw-desc" class="remark-box" placeholder="Your notes or answers..."></textarea>
          </label>
        </div>
        <div class="file-upload">
          <label>Attach file: <input type="file" id="submithw-file" required></label>
        </div>
        <button type="submit" class="btn">Submit Homework</button>
      </form>
      <div id="submithw-list" style="margin-top:18px;"></div>
    </div>
    <!-- Teacher Comment Tab -->
    <div class="tab-section" id="tab-comment">
      <div class="portal-title">Teacher Comments</div>
      <form id="comment-form">
        <label>Student:
          <select id="comment-student" class="input-medium"></select>
        </label>
        <br>
        <textarea id="comment-box" class="comment-box" placeholder="Type comment here..." required></textarea>
        <br>
        <button type="submit" class="btn">Add Comment</button>
      </form>
      <div id="comment-list" style="margin-top:18px;"></div>
    </div>
    <!-- Parent Feedback Tab -->
    <div class="tab-section" id="tab-feedback">
      <div class="portal-title">Parent Feedback</div>
      <form id="feedback-form">
        <label>Student:
          <select id="feedback-student" class="input-medium"></select>
        </label>
        <br>
        <textarea id="feedback-box" class="feedback-box" placeholder="Parent feedback, suggestions, or questions..." required></textarea>
        <br>
        <button type="submit" class="btn">Submit Feedback</button>
      </form>
      <div id="feedback-list" style="margin-top:18px;"></div>
    </div>
  </div>
  <!-- Notice Popup Modal (custom) -->
  <div id="notice-popup-modal">
    <div id="notice-popup-content">
      <div id="notice-popup-message" style="font-size:1.10rem;line-height:1.7;color:#1c69a8;"></div>
      <div style="text-align:center;margin-top:18px;">
        <button id="notice-popup-ok" class="btn" style="padding:8px 32px;font-size:1.07rem;">OK</button>
      </div>
    </div>
  </div>
  <script>
    // --- Student List ---
    const students = [
      "Stenson - J2 KKMS",
      "Chantelle Lo - J2 KKMS",
      "Moses - J2 KKMS",
      "Jeremiah - J2 KKMS",
      "Ang Yi Yang - J2 TTSS",
      "Charles Wong - J2 TTSS",
      "Kelsey - J2 TTSS",
      "Chloe Tay - J2 TTSS",
      "Liew Xin Yi - J2 TTSS",
      "Bryan Boon - J2 TTSS",
      "Voon Neng - J2 TTSS",
      "Eva - S2 KKMS",
      "Mindy - S2 KKMS",
      "Lily - S2 TTSS",
      "Jeremy Sii - F4 KKHS",
      "Aaron - F4 KKHS",
      "Yap Xian Hui - F5 KKHS",
      "Rayyan - J3 KKMS",
      "Wong Jia Heng - J3 KKMS",
      "Charleston - J3 KKMS",
      "Marcos - J3 KKMS",
      "Jason - J3 KKMS",
      "Rachel - J3 KKMS",
      "Jake - J3 KKMS",
      "Jibran - J3 KKMS",
      "LZP - J3 KKMS",
      "Alden - J3 KKMS",
      "Chloe Voo - J3 KKMS",
      "Abby - J3 KKMS",
      "Lyyn - Y7 KIS"
    ];
    function getClassFromStudent(s) {
      let parts = s.split("-");
      return parts.length > 1 ? parts[1].trim() : '';
    }

    // ---- Attendance Section ----
    function renderAttendanceTable() {
      const tbody = document.getElementById('student-tbody');
      tbody.innerHTML = students.map((student, idx) => `
        <tr>
          <td>${student}</td>
          <td><input class="status-checkbox" type="checkbox" name="status_p_${idx}" value="P"></td>
          <td><input class="status-checkbox" type="checkbox" name="status_a_${idx}" value="A"></td>
          <td><input class="status-checkbox" type="checkbox" name="status_x_${idx}" value="X"></td>
          <td><input class="status-checkbox" type="checkbox" name="status_r_${idx}" value="R"></td>
          <td><input class="status-checkbox" type="checkbox" name="status_ph_${idx}" value="PH"></td>
        </tr>
      `).join('');
    }
    renderAttendanceTable();

    function getAttendance() {
      return JSON.parse(localStorage.getItem('attendance') || '[]');
    }
    function setAttendance(data) {
      localStorage.setItem('attendance', JSON.stringify(data));
    }
    function updateDayOfWeek() {
      const dateInput = document.getElementById('date');
      const dayOfWeekSpan = document.getElementById('day-of-week');
      if (dateInput.value) {
        const date = new Date(dateInput.value + 'T00:00:00');
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        dayOfWeekSpan.textContent = days[date.getDay()];
      } else {
        dayOfWeekSpan.textContent = '';
      }
    }
    document.getElementById('date').addEventListener('input', updateDayOfWeek);

    document.getElementById('attendance-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const remark = document.getElementById('remark').value.trim();
      if (!date) return;
      const attendance = getAttendance();
      const newRecords = [];
      students.forEach((student, idx) => {
        let status = '';
        if (document.querySelector(`[name="status_p_${idx}"]`).checked) status = 'P';
        if (document.querySelector(`[name="status_a_${idx}"]`).checked) status = 'A';
        if (document.querySelector(`[name="status_x_${idx}"]`).checked) status = 'X';
        if (document.querySelector(`[name="status_r_${idx}"]`).checked) status = 'R';
        if (document.querySelector(`[name="status_ph_${idx}"]`).checked) status = 'PH';
        newRecords.push({ date, student, status, remark });
      });
      const filtered = attendance.filter(r => r.date !== date || !students.includes(r.student));
      const updated = filtered.concat(newRecords);
      setAttendance(updated);
      document.getElementById('message').textContent = 'Attendance saved!';
      setTimeout(() => { document.getElementById('message').textContent = ""; }, 2000);
      this.reset();
      updateDayOfWeek();
      renderAttendanceAnalysis();
      renderMatrix();
    });
    function renderAttendanceAnalysis() {
      const attendance = getAttendance();
      const date = document.getElementById('date').value;
      if (!date) { document.getElementById('attendance-analysis').innerHTML = ""; return; }
      let total = 0, present = 0, absent = 0, missed = 0, repl = 0, holiday = 0;
      students.forEach(student => {
        const rec = attendance.find(r => r.date === date && r.student === student);
        if (rec && rec.status) {
          total++;
          if (rec.status === 'P') present++;
          if (rec.status === 'A') absent++;
          if (rec.status === 'X') missed++;
          if (rec.status === 'R') repl++;
          if (rec.status === 'PH') holiday++;
        }
      });
      if (total === 0) { document.getElementById('attendance-analysis').innerHTML = ""; return; }
      const pct = n => total ? ((n / total * 100).toFixed(0)) : 0;
      document.getElementById('attendance-analysis').innerHTML =
        `<span class="attendance-analysis">
        Present: <span style="color:#1dbb75;">${present}</span> (${pct(present)}%) &nbsp; 
        Absent: <span style="color:#f45151;">${absent}</span> (${pct(absent)}%) &nbsp; 
        Missed: <span style="color:#e9b200;">${missed}</span> (${pct(missed)}%) &nbsp;
        Replacement: <span style="color:#1790f7;">${repl}</span> (${pct(repl)}%) &nbsp;
        Public Holiday: <span style="color:#e40000;">${holiday}</span> (${pct(holiday)}%)
        </span>`;
    }
    document.getElementById('date').addEventListener('input', renderAttendanceAnalysis);

    window.onload = function() {
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      updateDayOfWeek();
      renderAttendanceAnalysis();
      fillExamStudentSelect();
      fillPaymentStudentSelect();
      fillCommentStudentSelect();
      fillFeedbackStudentSelect();
      fillSubmitHWSelects();
      fillHWClassOptions();
      fillSetPayStudent();
      renderNoticeList();
      showNoticePopUpOnce();
    };

    // -------- Matrix Logic -----------
 function renderMatrix() {
    const attendance = getAttendance();
    const filter = document.getElementById('matrix-filter').value.toLowerCase();
    const allDates = Array.from(new Set(attendance.map(r => r.date))).sort((a,b) => a.localeCompare(b));
    const dateDayMap = {};
    allDates.forEach(date => {
      const d = new Date(date + 'T00:00:00');
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      dateDayMap[date] = days[d.getDay()];
    });
    const matrix = {};
    students.forEach(s => matrix[s] = {});
    attendance.forEach(r => {
      if (matrix[r.student]) {
        matrix[r.student][r.date] = r.status || "";
      }
    });
    const remarksMap = {};
    allDates.forEach(date => {
      const rem = attendance.find(r => r.date === date && r.remark);
      remarksMap[date] = rem && rem.remark ? rem.remark : "";
    });
    let shownStudents = students;
    if (filter) {
      shownStudents = students.filter(stu =>
        stu.toLowerCase().includes(filter) ||
        getClassFromStudent(stu).toLowerCase().includes(filter)
      );
    }
    let html = '<thead><tr><th>Student</th>';
    allDates.forEach(date => {
      html += `<th class="matrix-date">${date}<br>${dateDayMap[date]}</th>`;
    });
    html += '<th class="matrix-status-P">P</th><th class="matrix-status-A">A</th><th class="matrix-status-X">X</th><th class="matrix-status-R">R</th><th class="matrix-status-PH">PH</th><th>Total</th><th>Scheduled Class</th><th>Attended %</th></tr></thead><tbody>';
    shownStudents.forEach((student, rowIdx) => {
      html += `<tr><td style="background:var(--matrix-header);color:#0a5077;">${student}</td>`;
      let P=0,A=0,X=0,R=0,PH=0,expected=0;
      allDates.forEach(date => {
        const v = matrix[student][date] || "";
        let statusClass = "";
        if (v === "P") { statusClass = "matrix-status-P"; P++; expected++; }
        else if (v === "A") { statusClass = "matrix-status-A"; A++; expected++; }
        else if (v === "X") { statusClass = "matrix-status-X"; X++; }
        else if (v === "R") { statusClass = "matrix-status-R"; R++; }
        else if (v === "PH") { statusClass = "matrix-status-PH"; PH++; }
        html += `<td class="matrix-date${statusClass ? ' '+statusClass : ''}">${v}</td>`;
      });
      let total = P + A + X + R + PH;
html += `<td class="matrix-status-P">${P}</td><td class="matrix-status-A">${A}</td><td class="matrix-status-X">${X}</td><td class="matrix-status-R">${R}</td><td class="matrix-status-PH">${PH}</td>`;
html += `<td>${total}</td>`;
html += `<td><input type="number" min="0" value="${expected}" data-row="${rowIdx}" class="matrix-expected" style="width:50px;"></td>`;
let percent = expected ? (((P + R)/expected)*100).toFixed(0) : '';
html += `<td class="matrix-percent">${percent}</td>`;
      html += '</tr>';
    });
    html += `<tr><td class="remarks-cell"><b>Remarks</b></td>`;
    allDates.forEach(date => {
      html += `<td class="remarks-cell matrix-date">${remarksMap[date] ? remarksMap[date] : ''}</td>`;
    });
    html += '<td colspan="7"></td></tr>';
    html += '</tbody>';
    document.getElementById('matrix-table').innerHTML = html;
    document.querySelectorAll('.matrix-expected').forEach(inp => {
      inp.onchange = function() {
        let rowIdx = +this.getAttribute('data-row');
        let row = this.closest('tr');
        let P = +row.children[allDates.length+1].textContent;
        let expected = +this.value || 0;
        let pct = expected ? ((P/expected)*100).toFixed(0) : '';
        row.children[allDates.length+8].textContent = pct;
      }
    });
  }
    document.getElementById('matrix-filter').addEventListener('input', renderMatrix);
    function exportMatrix() {
      const attendance = getAttendance();
      const allDates = Array.from(new Set(attendance.map(r => r.date))).sort((a,b) => b.localeCompare(a));
      const dateDayMap = {};
      allDates.forEach(date => {
        const d = new Date(date + 'T00:00:00');
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dateDayMap[date] = days[d.getDay()];
      });
      const matrix = {};
      students.forEach(s => matrix[s] = {});
      attendance.forEach(r => {
        if (matrix[r.student]) {
          matrix[r.student][r.date] = r.status || "";
        }
      });
      const remarksMap = {};
      allDates.forEach(date => {
        const rem = attendance.find(r => r.date === date && r.remark);
        remarksMap[date] = rem && rem.remark ? rem.remark : "";
      });
      let csv = ["Student," + allDates.map(date=>`${date} (${dateDayMap[date]})`).join(",") +
        ",P,A,X,R,PH,Expected,Attended %"];
      students.forEach(student => {
        let P=0,A=0,X=0,R=0,PH=0,expected=0;
        let row = [student];
        allDates.forEach(date => {
          const v = matrix[student][date] || "";
          row.push(v);
          if(v==="P") {P++;expected++;}
          else if(v==="A") {A++;expected++;}
          else if(v==="X") {X++;}
          else if(v==="R") {R++;}
          else if(v==="PH") {PH++;}
        });
        let percent = expected ? ((P/expected)*100).toFixed(0) : '';
        row.push(P,A,X,R,PH,expected,percent);
        csv.push(row.join(","));
      });
      csv.push("Remarks," + allDates.map(date => '"' + (remarksMap[date]||'').replace(/"/g,'""') + '"').join(",") + ',,,,,,,');
      const blob = new Blob([csv.join("\r\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "attendance_matrix.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    window.exportMatrix = exportMatrix;

    // --- Exam Scores ---
    function fillExamStudentSelect() {
      const sel = document.getElementById('exam-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
      updateExamClass();
    }
    function updateExamClass() {
      const idx = document.getElementById('exam-student').selectedIndex;
      if (idx >= 0) {
        document.getElementById('exam-class').innerText = getClassFromStudent(students[idx]);
      }
    }
    document.getElementById('exam-student').addEventListener('change', updateExamClass);

    function getExam() { return JSON.parse(localStorage.getItem('exam') || '[]'); }
    function setExam(data) { localStorage.setItem('exam', JSON.stringify(data)); }
    function renderExamTable() {
      const exam = getExam();
      const filter = document.getElementById('exam-filter').value.toLowerCase();
      let grouped = {};
      exam.forEach(r => {
        if (filter && !(r.student.toLowerCase().includes(filter) || getClassFromStudent(r.student).toLowerCase().includes(filter) || r.examName.toLowerCase().includes(filter))) return;
        if (!grouped[r.student]) grouped[r.student] = [];
        grouped[r.student].push(r);
      });
      Object.values(grouped).forEach(arr => {
        arr.sort((a, b) => {
          let anum = parseInt(a.examName.match(/\d+/)?.[0] || 9999);
          let bnum = parseInt(b.examName.match(/\d+/)?.[0] || 9999);
          if (!isNaN(anum) && !isNaN(bnum)) return anum - bnum;
          return a.examName.localeCompare(b.examName);
        });
      });
      let html = '';
      Object.keys(grouped).forEach(student => {
        let cls = getClassFromStudent(student);
        grouped[student].forEach(r => {
          const name = r.student.split('-')[0].trim();
          html += `<tr>
            <td>${name}</td>
            <td>${cls}</td>
            <td>${r.examName}</td>
            <td>${r.score}</td>
            <td><button type="button" class="btn" style="padding:3px 12px;font-size:0.88rem;" onclick="removeExam(${exam.indexOf(r)})">Del</button></td>
          </tr>`;
        });
      });
      document.getElementById('exam-tbody').innerHTML = html;
    }
    document.getElementById('exam-form').onsubmit = function(e){
      e.preventDefault();
      const idx = document.getElementById('exam-student').selectedIndex;
      const student = students[idx];
      let examName = document.getElementById('exam-name').value;
      if (examName === "other") examName = document.getElementById('exam-other').value;
      const score = document.getElementById('exam-score').value;
      const exam = getExam();
      exam.push({ student, examName, score });
      setExam(exam);
      this.reset();
      renderExamTable();
      updateExamClass();
    }
    window.removeExam = function(i) {
      const exam = getExam();
      exam.splice(i,1); setExam(exam); renderExamTable();
    }
    document.getElementById('exam-name').addEventListener('change', function() {
      document.getElementById('exam-other').style.display = this.value === "other" ? "inline-block" : "none";
    });
    document.getElementById('exam-filter').addEventListener('input', renderExamTable);

    // --- Payment Section ---
    function fillPaymentStudentSelect() {
      const sel = document.getElementById('payment-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
      updatePaymentClassAndAmount();
    }
    function updatePaymentClassAndAmount() {
      const idx = document.getElementById('payment-student').selectedIndex;
      if (idx >= 0) {
        document.getElementById('payment-class').innerText = getClassFromStudent(students[idx]);
        const amt = getPayAmountForStudent(students[idx]);
        document.getElementById('payment-auto-amount').innerHTML = `<span style="font-weight:600;color:#1790f7;">RM${amt||0}</span>`;
      }
    }
    document.getElementById('payment-student').addEventListener('change', updatePaymentClassAndAmount);

    function getPayment() { return JSON.parse(localStorage.getItem('payment') || '[]'); }
    function setPayment(data) { localStorage.setItem('payment', JSON.stringify(data)); }
    function getPayAmounts() { return JSON.parse(localStorage.getItem('payamts') || '{}'); }
    function setPayAmounts(data) { localStorage.setItem('payamts', JSON.stringify(data)); }
    function getPayAmountForStudent(s) {
      let amts = getPayAmounts();
      return amts[s] || 0;
    }
    function setPaymentAmount() {
      const idx = document.getElementById('setpay-student').selectedIndex;
      const student = students[idx];
      const amt = document.getElementById('setpay-amount').value;
      let amts = getPayAmounts();
      amts[student] = amt;
      setPayAmounts(amts);
      document.getElementById('setpay-msg').innerText = "Payment set!";
      updatePaymentClassAndAmount();
      setTimeout(()=>{document.getElementById('setpay-msg').innerText="";},1200);
    }
    function fillSetPayStudent() {
      const sel = document.getElementById('setpay-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
    }
    function renderPaymentTable() {
      const payment = getPayment();
      const filter = document.getElementById('payment-filter').value.toLowerCase();
      document.getElementById('payment-tbody').innerHTML = payment.map((r,i) => {
        const name = r.student.split('-')[0].trim();
        const cls = getClassFromStudent(r.student);
        if (filter && !(r.student.toLowerCase().includes(filter) || cls.toLowerCase().includes(filter) || (r.month||"").toLowerCase().includes(filter))) return '';
        return `<tr>
          <td>${name}</td>
          <td>${cls}</td>
          <td><input type="number" min="0" value="${r.amount}" onchange="editPayment(${i},'amount',this.value)"></td>
          <td><input type="month" value="${r.month||''}" onchange="editPayment(${i},'month',this.value)"></td>
          <td><input type="date" value="${r.payOn||''}" onchange="editPayment(${i},'payOn',this.value)"></td>
          <td>
            <select onchange="editPayment(${i},'payBy',this.value)">
              <option value="PBB"${r.payBy==='PBB'?' selected':''}>PBB</option>
              <option value="CIMB"${r.payBy==='CIMB'?' selected':''}>CIMB</option>
              <option value="MBB"${r.payBy==='MBB'?' selected':''}>MBB</option>
              <option value="Cash"${r.payBy==='Cash'?' selected':''}>Cash</option>
            </select>
          </td>
          <td>
            <select onchange="editPayment(${i},'status',this.value)">
              <option${r.status==='Paid'?' selected':''}>Paid</option>
              <option${r.status==='Unpaid'?' selected':''}>Unpaid</option>
            </select>
          </td>
          <td>
            <button type="button" class="btn" style="padding:3px 12px;font-size:0.88rem;" onclick="removePayment(${i})">Del</button>
          </td>
        </tr>`;
      }).join('');
    }
    function editPayment(i, field, value) {
      const payment = getPayment();
      payment[i][field] = value;
      setPayment(payment);
    }
    document.getElementById('payment-form').onsubmit = function(e){
      e.preventDefault();
      const idx = document.getElementById('payment-student').selectedIndex;
      const student = students[idx];
      const amount = getPayAmountForStudent(student);
      const month = document.getElementById('payment-month').value;
      const payOn = document.getElementById('payment-date').value;
      const paidBy = document.getElementById('payment-paidBy').value;
      const status = document.getElementById('payment-status').value;
      const payment = getPayment();
      payment.push({ student, amount, month, payOn, paidBy, status });
      setPayment(payment);
      this.reset();
      renderPaymentTable();
      updatePaymentClassAndAmount();
    }
    window.removePayment = function(i) {
      const payment = getPayment();
      payment.splice(i,1); setPayment(payment); renderPaymentTable();
    }
    document.getElementById('payment-filter').addEventListener('input', renderPaymentTable);

    // --- Notice Board ---
    function getNotice() { return JSON.parse(localStorage.getItem('notice') || '[]'); }
    function setNotice(data) { localStorage.setItem('notice', JSON.stringify(data)); }
    function renderNoticeList() {
      const notice = getNotice();
      document.getElementById('notice-list').innerHTML = notice.length === 0
        ? "<i>No notice posted yet.</i>"
        : notice.map((n,i) =>
          `<div style="margin-bottom:12px;">
             <span class="notice-title">${n.title}</span>
             <div>${n.content.replace(/(?:\d{4}-\d{2}-\d{2}|\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{2,4})/g, (match) => `<span class="notice-date">${match}</span>`).replace(/\n/g, "<br>")}</div>
             <div style="margin-top:1em;color:#1790f7;font-weight:600;">Best Regards, Teacher Kwan and Team</div>
             <div style="color:#1790f7;">Thank you :)</div>
             <button class="btn" style="padding:3px 10px;font-size:0.85rem;" onclick="editNotice(${i})">Edit</button>
             <button class="btn" style="padding:3px 10px;font-size:0.85rem;" onclick="removeNotice(${i})">Remove</button>
           </div>`).join('');
    }
    document.getElementById('notice-form').onsubmit = function(e){
      e.preventDefault();
      const notice = getNotice();
      notice.unshift({
        title: document.getElementById('notice-title').value,
        content: document.getElementById('notice-content').value,
        date: new Date().toISOString().slice(0,10),
        periodStart: document.getElementById('notice-period-start').value,
        periodEnd: document.getElementById('notice-period-end').value
      });
      setNotice(notice.slice(0,30));
      this.reset();
      renderNoticeList();
    }
    window.editNotice = function(index) {
      const notice = getNotice();
      const n = notice[index];
      document.getElementById('notice-title').value = n.title;
      document.getElementById('notice-content').value = n.content;
      document.getElementById('notice-period-start').value = n.periodStart;
      document.getElementById('notice-period-end').value = n.periodEnd;
      notice.splice(index,1);
      setNotice(notice);
      renderNoticeList();
    }
    window.removeNotice = function(i) {
      const notice = getNotice();
      notice.splice(i,1); setNotice(notice); renderNoticeList();
    }
    function showNoticePopUpOnce() {
      const notice = getNotice();
      if (!notice.length) return;
      const now = new Date();
      for(let n of notice) {
        if (n.periodStart && n.periodEnd) {
          let start = new Date(n.periodStart+"T00:00:00");
          let end = new Date(n.periodEnd+"T23:59:59");
          if (now >= start && now <= end) {
            if (!sessionStorage.getItem("noticepopup_" + n.title + n.periodStart + n.periodEnd)) {
              setTimeout(() => {
                showStyledNoticePopup(n.title, n.content);
                sessionStorage.setItem("noticepopup_" + n.title + n.periodStart + n.periodEnd, "1");
              }, 500);
            }
          }
        }
      }
    }
    // --- Homework Upload/Submission ---
    function getClassList() {
      return Array.from(new Set(students.map(getClassFromStudent)));
    }
    function fillHWClassOptions() {
      const sel = document.getElementById('uploadhw-class');
      sel.innerHTML = getClassList().map(cls => `<option value="${cls}">${cls}</option>`).join('');
    }
    function getHW() { return JSON.parse(localStorage.getItem('hw') || '[]'); }
    function setHW(data) { localStorage.setItem('hw', JSON.stringify(data)); }
    function renderHWList() {
      const hw = getHW();
      document.getElementById('hw-list').innerHTML = hw.length === 0
        ? "<i>No homework uploaded yet.</i>"
        : '<table class="homework-table"><tr><th>Title</th><th>Description</th><th>Class</th><th>Due</th><th>Due Time</th><th>File</th><th>Action</th></tr>' +
          hw.map((h,i) =>
            `<tr>
              <td>${h.title}</td>
              <td>${h.desc||''}</td>
              <td>${h.cls}</td>
              <td>${h.due}</td>
              <td>${h.dueTime||''}</td>
              <td>${h.fileName ? `<a href="${h.fileUrl}" download="${h.fileName}">${h.fileName}</a>` : '-'}</td>
              <td><button class="btn" style="padding:3px 10px;font-size:0.85rem;" onclick="removeHW(${i})">Del</button></td>
            </tr>`).join('') + '</table>';
    }
    document.getElementById('uploadhw-form').onsubmit = function(e){
      e.preventDefault();
      const hw = getHW();
      const fileInput = document.getElementById('uploadhw-file');
      let fileName = "", fileUrl = "";
      if (fileInput.files.length) {
        fileName = fileInput.files[0].name;
        fileUrl = URL.createObjectURL(fileInput.files[0]);
      }
      hw.unshift({
        title: document.getElementById('uploadhw-title').value,
        desc: document.getElementById('uploadhw-desc').value,
        cls: document.getElementById('uploadhw-class').value,
        due: document.getElementById('uploadhw-due').value,
        dueTime: document.getElementById('uploadhw-duetime').value,
        fileName,
        fileUrl,
        uploadTime: new Date().toISOString()
      });
      setHW(hw.slice(0,40));
      this.reset();
      renderHWList();
      document.getElementById('uploadhw-file').value = "";
    }
    window.removeHW = function(i) {
      const hw = getHW();
      hw.splice(i,1); setHW(hw); renderHWList();
    }
    // -- Submit Homework
    function fillSubmitHWSelects() {
      const sel = document.getElementById('submithw-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
      const hw = getHW();
      const s2 = document.getElementById('submithw-hw');
      s2.innerHTML = hw.map((h,i) => `<option value="${i}">${h.title} (${h.cls}, Due: ${h.due} ${h.dueTime||''})</option>`).join('');
    }
    function getSubmitHW() { return JSON.parse(localStorage.getItem('submithw') || '[]'); }
    function setSubmitHW(data) { localStorage.setItem('submithw', JSON.stringify(data)); }
    function getComments() { return JSON.parse(localStorage.getItem('comment') || '[]'); }
    function renderSubmitHWList() {
      const sub = getSubmitHW();
      const student = document.getElementById('submithw-student').value;
      document.getElementById('submithw-list').innerHTML = sub.length === 0
        ? "<i>No homework submitted yet.</i>"
        : '<table class="homework-table"><tr><th>Homework</th><th>Description</th><th>Submission Time</th><th>File</th><th>Teacher Comments</th></tr>' +
          sub.filter(h=>!student||h.student===student)
          .map(h => {
            let comments = getComments().filter(c=>c.student===h.student).map(c=>c.text).join("<br>");
            return `<tr>
              <td>${h.hwTitle}</td>
              <td>${h.desc||''}</td>
              <td>${h.submitTime.replace("T"," ").slice(0,16)}</td>
              <td>${h.fileName ? `<a href="${h.fileUrl}" download="${h.fileName}">${h.fileName}</a>` : '-'}</td>
              <td>${comments||'-'}</td>
            </tr>`;
          }).join('') + '</table>';
    }
    document.getElementById('submithw-form').onsubmit = function(e){
      e.preventDefault();
      const sub = getSubmitHW();
      const idx = document.getElementById('submithw-hw').value;
      const hw = getHW();
      const studentidx = document.getElementById('submithw-student').selectedIndex;
      const student = students[studentidx];
      const hwTitle = hw[idx]?.title || "";
      const desc = document.getElementById('submithw-desc').value;
      const fileInput = document.getElementById('submithw-file');
      let fileName = "", fileUrl = "";
      if (fileInput.files.length) {
        fileName = fileInput.files[0].name;
        fileUrl = URL.createObjectURL(fileInput.files[0]);
      }
      sub.unshift({
        student, hwTitle, fileName, fileUrl, desc,
        submitTime: new Date().toISOString()
      });
      setSubmitHW(sub.slice(0,80));
      this.reset();
      renderSubmitHWList();
      document.getElementById('submithw-file').value = "";
    }

    // --------- Teacher Comments ---------
    function fillCommentStudentSelect() {
      const sel = document.getElementById('comment-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
    }
    function getComment() { return JSON.parse(localStorage.getItem('comment') || '[]'); }
    function setComment(data) { localStorage.setItem('comment', JSON.stringify(data)); }
    function renderCommentList() {
      const comment = getComment();
      document.getElementById('comment-list').innerHTML = comment.length === 0
        ? "<i>No comments yet.</i>"
        : '<table class="form-table"><tr><th>Student</th><th>Comment</th><th>Time</th><th>Action</th></tr>' +
          comment.map((c,i) =>
            `<tr>
              <td>${c.student.split('-')[0].trim()}</td>
              <td>${c.text.replace(/\n/g,"<br>")}</td>
              <td>${c.time.replace("T"," ").slice(0,16)}</td>
              <td><button class="btn" style="padding:3px 10px;font-size:0.85rem;" onclick="removeComment(${i})">Del</button></td>
            </tr>`).join('') + '</table>';
    }
    document.getElementById('comment-form').onsubmit = function(e){
      e.preventDefault();
      const comment = getComment();
      const idx = document.getElementById('comment-student').selectedIndex;
      const student = students[idx];
      comment.unshift({
        student: student,
        text: document.getElementById('comment-box').value,
        time: new Date().toISOString()
      });
      setComment(comment.slice(0,50));
      this.reset();
      renderCommentList();
    }
    window.removeComment = function(i) {
      const comment = getComment();
      comment.splice(i,1); setComment(comment); renderCommentList();
    }

    // --------- Parent Feedback ---------
    function fillFeedbackStudentSelect() {
      const sel = document.getElementById('feedback-student');
      sel.innerHTML = students.map(s => `<option value="${s}">${s.split('-')[0].trim()}</option>`).join('');
    }
    function getFeedback() { return JSON.parse(localStorage.getItem('feedback') || '[]'); }
    function setFeedback(data) { localStorage.setItem('feedback', JSON.stringify(data)); }
    function renderFeedbackList() {
      const feedback = getFeedback();
      document.getElementById('feedback-list').innerHTML = feedback.length === 0
        ? "<i>No feedback yet.</i>"
        : '<table class="feedback-table"><tr><th>Student</th><th>Feedback</th><th>Time</th><th>Action</th></tr>' +
          feedback.map((f,i) =>
            `<tr>
              <td>${f.student.split('-')[0].trim()}</td>
              <td>${f.text.replace(/\n/g,"<br>")}</td>
              <td>${f.time.replace("T"," ").slice(0,16)}</td>
              <td><button class="btn" style="padding:3px 10px;font-size:0.85rem;" onclick="removeFeedback(${i})">Del</button></td>
            </tr>`).join('') + '</table>';
    }
    document.getElementById('feedback-form').onsubmit = function(e){
      e.preventDefault();
      const feedback = getFeedback();
      const idx = document.getElementById('feedback-student').selectedIndex;
      const student = students[idx];
      feedback.unshift({
        student: student,
        text: document.getElementById('feedback-box').value,
        time: new Date().toISOString()
      });
      setFeedback(feedback.slice(0,50));
      this.reset();
      renderFeedbackList();
    }
    window.removeFeedback = function(i) {
      const feedback = getFeedback();
      feedback.splice(i,1); setFeedback(feedback); renderFeedbackList();
    }

    // --- Notice Popup Modal with Underline Red Dates/Days and line breaks ---
    function showStyledNoticePopup(title, content) {
      function underlineDatesAndDays(str) {
        if (!str) return '';
        // Underline various date formats (YYYY-MM-DD, D/M/YYYY, D-M-YYYY, D.M.YYYY, DD/MM/YYYY, etc.)
        str = str.replace(/\b(\d{1,4}[-\/\.]\d{1,2}[-\/\.]\d{1,4})\b/g, '<span class="notice-popup-date">$1</span>');
        // Underline days of week (full and short, case-insensitive)
        str = str.replace(/\b(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sun|Mon|Tue|Wed|Thu|Fri|Sat)\b/gi, '<span class="notice-popup-date">$1</span>');
        return str;
      }
      const modal = document.getElementById('notice-popup-modal');
      const msgDiv = document.getElementById('notice-popup-message');
      // First, replace line breaks with <br>, then underline
      let contentHtml = underlineDatesAndDays(content.replace(/\n/g, "<br>"));
      msgDiv.innerHTML =
        `<div style="font-size:1.14rem;font-weight:700;color:#1790f7;margin-bottom:7px;"> ${title}</div>` +
        `<div style="margin-bottom:12px;">${contentHtml}</div>` +
        `<div style="color:#1790f7;font-size:0.99rem;margin-top:16px;"><b>Best Regards, Teacher Kwan and Team</b></div>`;
      modal.style.display = 'flex';
      document.getElementById('notice-popup-ok').onclick = function() {
        modal.style.display = 'none';
      };
    }

    // --- Tab Navigation ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        if(btn.dataset.tab === "matrix") renderMatrix();
        if(btn.dataset.tab === "attendance") renderAttendanceAnalysis();
        if(btn.dataset.tab === "exam") renderExamTable();
        if(btn.dataset.tab === "payment") renderPaymentTable();
        if(btn.dataset.tab === "notice") renderNoticeList();
        if(btn.dataset.tab === "uploadhw") renderHWList();
        if(btn.dataset.tab === "submithw") {renderSubmitHWList(); fillSubmitHWSelects();}
        if(btn.dataset.tab === "comment") renderCommentList();
        if(btn.dataset.tab === "feedback") renderFeedbackList();
      }
    });
  </script>
</body>
</html>